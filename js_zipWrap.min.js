!function(x){x[0][x[1]]=function(zip,nodePath,cb){var join=nodePath.join,trailing_slashes_re=/(\/*)$/g,double_slash_re=/(\/\/+)/g,double_dot_parent_re=/(?<=\/)([^/]*\/\.\.\/)(?=)/;function true_path_from_path(path){return path=path.replace(trailing_slashes_re,"").replace(double_slash_re,""),0<=["/",""].indexOf(path)?"/":"/"===path[0]?path:"/"+path}function true_path_from_relative_path(cwd,path){for(0<=[".","",cwd].indexOf(path)?path=cwd:path.startsWith("/")||(path=path.startsWith("./")?join(cwd,path.substr(2)):join(cwd,path)),path=path.replace(trailing_slashes_re,"").replace(double_slash_re,"").replace(double_dot_parent_re,"");0<=path.search(double_dot_parent_re);)path=path.replace(double_dot_parent_re,"");return""===path?"/":path}function ab2str(buf){return String.fromCharCode.apply(null,new Uint16Array(buf))}function str2ab(str){for(var buf=new ArrayBuffer(2*str.length),bufView=new Uint16Array(buf),i=0,strLen=str.length;i<strLen;i++)bufView[i]=str.charCodeAt(i);return buf}var properties,wrap={},zip_fns=[],listing=[],directory={},watchers={},inodes={},getInode=function getInode(true_path){var result=inodes[true_path];return result||(getInode.next=(result=getInode.next||1e3)+1,inodes[true_path]=result),result},cwd="/";function utf8Encoding(str){return str}var bufferEncoding="object"==typeof process&&"function"==typeof Buffer?function(str){return Buffer.from(str)}:str2ab;if(reread(),properties=function(){var listing_true_path_filter=filtered_root_path;function errback(cb,err,data){if(err){if(cb)return cb(err);throw err}return cb?cb(null,data):data}function exists(true_path){return!!zip.files[directory[true_path]]}function isDir(true_path){var entry=zip.files[directory[true_path]];return entry&&entry.dir}function rm(path,cb){var true_path=true_path_from_relative_path(cwd,path);return zip.files[directory[true_path]]?(zip.remove(directory[true_path]),reread(),errback(cb)):errback(cb,new Error(path+" not found"))}function Stats(size,when,inode){this.ino=inode,this.size=size,this.atimeMs=when.getTime(),this.mtimeMs=this.atimeMs,this.ctimeMs=this.atimeMs,this.birthtimeMs=this.atimeMs,this.atime=when,this.mtime=this.atime,this.ctime=this.atime,this.birthtime=this.atime}function cp(src,dest,cb,_is_mv){var true_src=true_path_from_relative_path(cwd,src),true_dest=true_path_from_relative_path(cwd,dest);if(exists(true_src)){if(true_src===true_dest)return errback(cb,new Error("source and destination are the same"));var zip_fn_src=directory[true_src];if(exists(true_dest)){var zip_fn_dest=directory[true_src];return isDir(true_dest)?errback(cb,new Error(dest+" is a directory. mv failed")):(zip.remove(zip_fn_dest),do_mv(zip_fn_src))}return do_mv(zip_fn_src,true_dest.substr(1))}return errback(cb,new Error(src+" not found"));function do_mv(zip_fn_src){return(isDir(true_src)?function(zip_fn_src){var files_to_move,dir_to_move=wrap.view_dir(true_src,!0);if(cb){var source_files=(files_to_move=dir_to_move.files_objects).map(function(obj){return true_path_from_path(obj.name)}),offset=true_src.length+1,dest_files=source_files.map(function(fn){return true_dest+"/"+fn.substr(offset)});Promise.all(files_to_move.map(function(obj,ix){return obj.async("arraybuffer").catch(function(err){return err})})).then(function(buffers){var errors=buffers.filter(function(buf){return"object"==typeof buf&&buf.constructor===Error});if(0<errors.length){var err=new Error("errors while reading source files");return err.errors=errors,cb(err)}return buffers.forEach(function(buf,ix){var zip_dest=directory[dest_files[ix]]||dest_files[ix].substr(1);zip.file(zip_dest,buf,{binary:!0})}),_is_mv&&zip.remove(zip_fn_src),reread(),cb()}).catch(function(err){console.log({err:err})})}else{files_to_move=dir_to_move.files;var moved_ok=[];try{files_to_move.forEach(function(fn){var true_path_src=true_src+"/"+fn,true_path_dest=true_dest+"/"+fn;wrap.arraybuffer[true_path_dest]=wrap.arraybuffer[true_path_src](),moved_ok.push(true_path_dest)}),_is_mv&&zip.remove(zip_fn_src),moved_ok.splice(0,moved_ok.length)}finally{moved_ok.forEach(function(true_fn){zip.remove(directory[true_fn])}),reread()}}}:function(zip_fn_src){cb?wrap.arraybuffer[true_src](function(err,data){return err?errback(cb,err):(wrap.arraybuffer[true_dest]=data,_is_mv&&zip.remove(zip_fn_src),reread(),cb(null))}):(wrap.arraybuffer[true_dest]=wrap.arraybuffer[true_src](),_is_mv&&zip.remove(zip_fn_src),reread())})(zip_fn_src)}}return augmentProps(["listing","files","dirs"],[],"",{recursive:{get:function(){return listing_true_path_filter===filtered_always},set:function(value){listing_true_path_filter=value?filtered_always:filtered_root_path}},listing:{get:function(filtermode){return listing.filter(filtermode||listing_true_path_filter)}},files:{get:function(filtermode){return listing.filter(filtermode||listing_true_path_filter).filter(isFile)}},dirs:{get:function(filtermode){return listing.filter(filtermode||listing_true_path_filter).filter(isDir)}},mkdir:{value:function(path,cb){var true_path=true_path_from_relative_path(cwd,path);if("/"===true_path||zip.files[directory[true_path]])return errback(cb,new Error("can't mkdir "+path+"already exists"+(zip.files[directory[true_path]].dir?"":" (a file)")));var parent_path=nodePath.dirname(true_path),parent_dir=zip.files[directory[parent_path]];if("/"===parent_path||parent_dir){if("/"===parent_path||parent_dir.dir){var zip_fn=true_path.substr(1);return zip.folder(zip_fn),reread(),errback(cb)}return errback(cb,new Error("can't mkdir '"+path+"' - '"+parent_dir.name+"' is not a directory"))}return errback(cb,new Error("can't mkdir '"+path+"' - '"+parent_path+"' not found"))}},mkdirp:{value:function(path,cb){var true_path=true_path_from_relative_path(cwd,path);if(zip.files[directory[true_path]])return errback(cb,new Error("can't mkdir "+path+"already exists"+(zip.files[directory[true_path]].dir?"":" (a file)")));var zip_fn=true_path.substr(1);return zip.folder(zip_fn),reread(),errback(cb)}},rmdir:{value:function(path,cb){var true_path=true_path_from_relative_path(cwd,path);return exists(true_path)?isDir(true_path)?function(true_path){return isDir(true_path)&&0===view_chdir(true_path).length}(true_path)?rm(path,cb):errback(cb,new Error(path+" is not empty")):errback(cb,new Error(path+" is not a directory")):errback(cb,new Error(path+" not found"))}},rm:{value:rm},exists:{value:function(path,cb){var true_path=true_path_from_relative_path(cwd,path),answer="/"===true_path||exists(true_path);return cb?cb(answer):answer}},stat:{value:function(path,cb){var true_path=true_path_from_relative_path(cwd,path);if(exists(true_path)){var zip_fn=directory[true_path],ino=getInode(true_path),obj=zip.file(zip_fn);if(!obj)return errback(cb,new Error(path+" not found"));if(obj._data&&"number"==typeof obj._data.uncompressedSize)return errback(cb,null,new Stats(obj._data.uncompressedSize,obj.date,ino));if(!cb){function ignore(){}return obj.async("string").then(ignore).catch(ignore),errback(void 0,new Error(path+" not ready. try later"))}obj.async("string").then(function(data){return errback(cb,null,new Stats(data.length,obj.date,ino))}).catch(function(err){return errback(cb,err)})}}},mv:{value:function(src,dest,cb,_is_mv){return cp(src,dest,cb,!0)}},cp:{value:cp},listing_objects:{get:function(filtermode){return listing.filter(filtermode||listing_true_path_filter).map(get_object)}},files_objects:{get:function(filtermode){return listing.filter(filtermode||listing_true_path_filter).filter(isFile).map(get_object)}},dirs_objects:{get:function(filtermode){return listing.filter(filtermode||listing_true_path_filter).filter(isDir).map(get_object)}},string:{value:new Proxy({},file_proxy("string"))},arraybuffer:{value:new Proxy({},file_proxy("arraybuffer",{binary:!0}))},object:{value:function(path){return zip.file(directory[true_path_from_path(path)])}},addWatcher:{value:addWatcher},view_dir:{value:function(path,recursive){return view_chdir(path,recursive)}},chdir:{value:function(path){var new_path=true_path_from_relative_path(cwd,path);view_chdir(new_path),cwd=new_path}},reread:{value:reread},toJSON:{value:function(){var z,r;return{dir:function getDir(z){var r={};return z.get_dirs(!1).forEach(function(d){r[d.replace(/^\/{1}/,"")]=getDir(z.view_dir(d,!1))}),z.files_objects.forEach(function(f){r[nodePath.basename(f.name)]=f.date}),r}(wrap),files:(r={},(z=wrap).get_files(!0).forEach(function(f){var obj=zip.files[directory[f]];r[f]={size:obj._data.uncompressedSize,text:z.string[f]()}}),r)}}},ab2str:{value:ab2str},str2ab:{value:str2ab},trailing_slashes_re:{value:trailing_slashes_re},double_slash_re:{value:double_slash_re},double_dot_parent_re:{value:double_dot_parent_re},true_path_from_path:{value:true_path_from_path},true_path_from_relative_path:{value:true_path_from_relative_path},Stats:{value:Stats}})}(),Object.defineProperties(wrap,properties),"function"==typeof cb)var file_list=wrap.get_files(!0),bytes=0,loading=file_list.map(function(fn){return wrap.string[fn](function(err,data){var ix=loading.indexOf(fn);if(loading.splice(ix,1),bytes+=err?0:data.length,0===loading.length)return cb(wrap,bytes)}),fn});return wrap;function reread(){zip_fns.splice.apply(zip_fns,[0,zip_fns.length].concat(Object.keys(zip.files))),listing.splice.apply(listing,[0,listing.length].concat(zip_fns.map(true_path_from_path)));var current_inodes=listing.map(getInode);Object.keys(inodes).forEach(function(fn){var inode=inodes[fn];current_inodes.indexOf(inode)<0&&delete inodes[fn]}),Object.keys(directory).forEach(function(fn){delete directory[fn]}),zip_fns.forEach(function(zip_fn,ix){directory[listing[ix]]=zip_fn})}function get_object(path){return zip.files[directory[true_path_from_path(path)]]}function file_proxy(dtype,opts){function set_cache(obj,data){return delete obj.__cache_string,delete obj.__cache_arraybuffer,obj[cache_name]=data}var cache_name="__cache_"+dtype;return{get:function(x,path){var errpath=path;path=path.replace(/\$_/g,".").replace(/\$/g,"/");var true_path=true_path_from_relative_path(cwd,path),zip_fn=directory[true_path],obj=zip.files[zip_fn];if(obj&&obj.async){if(obj.dir)throw new Error("not a file:"+errpath+" ( "+path+" ) is a directory");function try_cache(){var data=function(obj){return obj[cache_name]?obj[cache_name]:obj.__cache_string&&"arraybuffer"===dtype?(obj.__cache_arraybuffer=str2ab(obj.__cache_string),obj.__cache_arraybuffer):obj.__cache_arraybuffer&&"string"===dtype?(obj.__cache_string=ab2str(obj.__cache_arraybuffer),obj.__cache_string):void 0}(obj);return!!data&&function(cb){return cb?cb(null,data):data}}var cacheAvail=try_cache();return cacheAvail?cacheAvail:obj.__pending?function(cb){return not_ready_yet(cb)}:(obj.__pending=[],obj.async(dtype).then(function(data){set_cache(obj,data),obj.__pending&&(obj.__pending.forEach(function(cb){cb(null,data)}),obj.__pending.splice(0,obj.__pending.length),delete obj.__pending)}).catch(function(newErr){obj.__pending&&(obj.__pending.forEach(function(cb){cb(newErr)}),obj.__pending.splice(0,obj.__pending.length),delete obj.__pending)}),not_ready_yet)}var err=new Error("not found:"+errpath+" ( "+path+" )");return function(cb){if("function"==typeof cb)return cb(err);throw err};function not_ready_yet(cb){var cacheAvail=try_cache();if(cacheAvail)return cacheAvail(cb);if(!cb)throw obj.__pending?((err=new Error(path+" not ready. retry later")).data=null,err.busy=!0,err.code="ENOTREADY",obj.__pending.push(function(data){err.data=data,err.busy=!1}),err):new Error("internal read error");if(obj.__pending)return obj.__pending.push(cb);cb(new Error("internal read error"))}},set:function(x,path,data){path=path.replace(/\$_/g,".").replace(/\$/g,"/");var watch_messages,true_path=true_path_from_relative_path(cwd,path),zip_fn=directory[true_path],obj=zip.files[zip_fn];function notify(watch_path){watchers[watch_path]&&watch_messages.forEach(function(watch_message){watchers[watch_path].forEach(function(fn){fn(watch_message,fn.encode(basename),new wrap.Stats(data.length,obj.date,inode))})})}watch_messages=obj&&obj.async?["change"]:(zip_fn=true_path.substr(1),directory[true_path]=zip_fn,zip_fns.push(zip_fn),listing.push(true_path),["rename","change"]),zip.file(zip_fn,data,opts),set_cache(zip.files[zip_fn],data),obj&&obj.async||(obj=zip.files[zip_fn]);var inode=getInode(true_path),basename=nodePath.basename(true_path);return notify(true_path),notify(nodePath.dirname(true_path)),!0}}}function isFile(zip_fn){var obj=get_object(zip_fn);return obj||console.log({isFile_undefined:zip_fn}),!!obj&&!obj.dir}function addWatcher(path,options,listener){if("string"!=typeof path){if("object"==typeof path||"string"!=typeof path.constructor.name||!path.constructor.name.endsWith("Buffer"))throw new Error("expecting a string or buffer for path");path=path.toString("utf8")}function notify_listeners(ev,file){listeners.forEach(function(fn){fn(ev,file)})}"function"==typeof options&&(listener=options,options={}),options.encoding?listener.encode=0<=["utf8","utf-8"].indexOf(options.encoding)?utf8Encoding:bufferEncoding:listener.encode=utf8Encoding;var true_path=true_path_from_relative_path(cwd,path),listeners=[],watch_stack=watchers[true_path]||(watchers[true_path]=[]);return watch_stack.push(notify_listeners),Object.defineProperties({},{close:{value:function(){var index=watch_stack.indexOf(notify_listeners);0<=index&&(watch_stack.splice(index,1),0===watch_stack.length&&delete watchers[true_path])}},addListener:{value:function(listener){if("function"!=typeof listener)throw new Error("invalid arg type");listeners.add(listener)}},removeListener:{value:function(listener){var ix=listeners.indexOf(listener);0<=ix&&listeners.splice(ix,1)}}})}function filtered_always(file){return!0}function filtered_root_path(file){return file.substr(1).indexOf("/")<0}function filtered_top_path(file){return file.indexOf("/")<0}function view_chdir(path,recursive){var true_path=true_path_from_path(path);if("/"!==true_path&&!zip.files[directory[true_path]])throw new Error(path+" not found");var view={},my_true_path_prefix="/"===true_path?"/":true_path+"/",mine_from=my_true_path_prefix.length,filtered=recursive?filtered_always:filtered_top_path,filtered_object=recursive?filtered_always:function(under){var mine_true=true_path_from_path(under),mine_from="/"===mine_true?1:mine_true.length+1;return function(obj){return filtered_top_path(true_path_from_path(obj.name).substr(mine_from))}}(true_path);return Object.defineProperties(view,augmentProps(["listing","files","dirs"],["mkdir","mkdirp","rmdir","rm","exists","stat","mv","cp"],true_path,{get_listing:{value:function(recursive){}},listing:{get:listing_view},files:{get:files_view},dirs:{get:dirs_view},listing_objects:{get:listing_objects_view},files_objects:{get:files_objects_view},dirs_objects:{get:dirs_objects_view},string:{value:file_proxy_view("string")},arraybuffer:{value:file_proxy_view("arraybuffer")},object:{value:function(path){return zip.file(directory[make_mine(path)])}},addWatcher:{value:function addWatcher(path,options,listener){return addWatcher(make_mine(path),options,listener)}},view_dir:{value:function(path,recursive){return view_chdir(make_mine(path),recursive)}},chdir:{value:function(path){wrap.chdir(true_path_from_relative_path(true_path,path))}},reread:{value:reread},toJSON:{value:function(){var j={dirs:{},files:{}},dirs=view.dirs,files=view.files;return dirs.forEach(function(dir){j.dirs[dir]=view.view_dir(dir).toJSON()}),files.forEach(function(fn,ix){j.files[fn]=view.string[fn](),j.dirs[fn]={date:view.files_objects[ix].date,size:j.files[fn].size}}),j}}}));function GET(what){return properties[what].get(filtered_always)}function make_mine(path){return path.startsWith("..")?"///badpath!":path.replace(/^(\.|\/)*/,my_true_path_prefix)}function my_part(path){return path.substr(mine_from)}function is_my_true_path(fn){return fn.startsWith(my_true_path_prefix)}function is_my_object(obj){return true_path_from_path(obj.name).startsWith(my_true_path_prefix)}function listing_view(filterMode){return listing.filter(is_my_true_path).map(my_part).filter(filterMode||filtered)}function files_view(filterMode){return GET("files").filter(is_my_true_path).map(my_part).filter(filterMode||filtered)}function dirs_view(filterMode){return GET("dirs").filter(is_my_true_path).map(my_part).filter(filterMode||filtered)}function listing_objects_view(){return GET("listing_objects").filter(is_my_object).filter(filtered_object)}function files_objects_view(){return GET("files_objects").filter(is_my_object).filter(filtered_object)}function dirs_objects_view(){return GET("dirs_objects").filter(is_my_object).filter(filtered_object)}function file_proxy_view(name){var parent_proxy=properties[name].value;return new Proxy({},{get:function(x,path){return parent_proxy[make_mine(path)]},set:function(x,path,data){return parent_proxy[make_mine(path)]=data,!0}})}}function augmentProps(recursive,pathwraps,true_path,props){var s,path_fixer=true_path_from_relative_path.bind(this,true_path),cpArgs=(s=Array.prototype.slice).call.bind(s);return recursive.forEach(function(cmd){props["get_"+cmd]={value:function(recursive){return props[cmd].get(recursive?filtered_always:void 0)},enumerable:!1,configurable:!0},props[cmd].enumerable=!0,props[cmd].configurable=!0}),pathwraps.forEach(function(cmd){var parent_handler=wrap[cmd],child_handler={};child_handler[cmd]=function(){var args=cpArgs(arguments),cb=args[args.length-1];return"function"==typeof cb&&args.pop(),args=args.map(path_fixer),"function"==typeof cb&&args.push(cb),parent_handler.apply(this,args)},props[cmd]={value:child_handler[cmd],enumerable:!0,configurable:!0}}),props}}}(typeof process+typeof module+typeof require=="objectobjectfunction"?[module,"exports"]:[window,"zipWrap"]);